From 787e23b146ab861890eeaaa62a43455b8538b5fc Mon Sep 17 00:00:00 2001
From: Robin Kauffman <robink@creosotehill.org>
Date: Tue, 5 Mar 2019 13:27:08 -0800
Subject: [PATCH] Fix OpenSSL enablement logic

---
 aconfigure.ac | 136 ++++++++++++++++----------------------------------
 1 file changed, 43 insertions(+), 93 deletions(-)

diff --git a/aconfigure.ac b/aconfigure.ac
index 2c272cdc..def9215a 100644
--- a/aconfigure.ac
+++ b/aconfigure.ac
@@ -1562,107 +1562,57 @@ if test "x$ac_cross_compile" != "x" -a "x$with_ssl" = "xno" -a "x$with_gnutls" =
     enable_ssl=no
 fi
 
-dnl # Include SSL support
+dnl # Correct --enable vs --disable SSL flipflop logic
 AC_SUBST(ac_no_ssl)
 AC_SUBST(ac_ssl_has_aes_gcm,0)
 AC_SUBST(ac_ssl_backend)
 AC_ARG_ENABLE(ssl,
 	      AS_HELP_STRING([--disable-ssl],
 			     [Exclude SSL support the build (default: autodetect)])
-	      ,
-	      [
-		if test "$enable_ssl" = "no"; then
-		 [ac_no_ssl=1]
-		 AC_MSG_RESULT([Checking if SSL support is disabled... yes])
-	        fi
-	      ],
-	      [
-                if test "x$with_ssl" != "xno" -a "x$with_ssl" != "x"; then
-                    CFLAGS="$CFLAGS -I$with_ssl/include"
-                    CPPFLAGS="$CPPFLAGS -I$with_ssl/include"
-                    LDFLAGS="$LDFLAGS -L$with_ssl/lib"
-                    AC_MSG_RESULT([Using SSL prefix... $with_ssl])
-                fi
-
-	        if test "x$with_gnutls" = "xno"; then
-
-		    AC_MSG_RESULT([checking for OpenSSL installations..])
-		    AC_SUBST(openssl_h_present)
-		    AC_SUBST(libssl_present)
-		    AC_SUBST(libcrypto_present)
-		    AC_CHECK_HEADER(openssl/ssl.h,[openssl_h_present=1])
-		    AC_CHECK_LIB(crypto,ERR_load_BIO_strings,[libcrypto_present=1 && LIBS="-lcrypto $LIBS"])
-		    AC_CHECK_LIB(ssl,SSL_CTX_new,[libssl_present=1 && LIBS="-lssl $LIBS"])
-		    if test "x$openssl_h_present" = "x1" -a "x$libssl_present" = "x1" -a "x$libcrypto_present" = "x1"; then
-	        	AC_MSG_RESULT([OpenSSL library found, SSL support enabled])
-			
-			# Check if SRTP should be compiled with OpenSSL
-			# support, to enable cryptos such as AES GCM.
-			
-			# EVP_CIPHER_CTX is now opaque in OpenSSL 1.1.0, libsrtp 1.5.4 uses it as a transparent type.
-			# Update 2.7: our bundled libsrtp has been upgraded to 2.1.0,
-			# so we can omit EVP_CIPHER_CTX definition check now.
-			AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[#include <openssl/evp.h>]],
-							  [EVP_CIPHER_CTX *ctx;EVP_aes_128_gcm();])],
-					  [AC_CHECK_LIB(crypto,EVP_aes_128_gcm,[ac_ssl_has_aes_gcm=1])])
-			if test "x$ac_ssl_has_aes_gcm" = "x1"; then
-				AC_MSG_RESULT([OpenSSL has AES GCM support, SRTP will use OpenSSL])
-			else
-				AC_MSG_RESULT([OpenSSL AES GCM support not found, SRTP will only support AES CM cryptos])
-			fi
+)
 
-			# PJSIP_HAS_TLS_TRANSPORT setting follows PJ_HAS_SSL_SOCK
-			#AC_DEFINE(PJSIP_HAS_TLS_TRANSPORT, 1)
-			AC_DEFINE(PJ_HAS_SSL_SOCK, 1)
-			AC_DEFINE(PJ_SSL_SOCK_IMP, PJ_SSL_SOCK_IMP_OPENSSL)
-			ac_ssl_backend="openssl"
-		    else
-			AC_MSG_RESULT([** OpenSSL libraries not found **])
-		    fi
-		
+dnl # OpenSSL detection
+AC_MSG_CHECKING([OpenSSL installations])
+if test "x$enable_ssl" = "xno"; then
+	ac_no_ssl=1
+	AC_MSG_RESULT([explicitly disabled])
+else
+	if test "x$with_ssl" != "xno" -a "x$with_ssl" != "x"; then
+		CFLAGS="$CFLAGS -I$with_ssl/include"
+		LDFLAGS="$LDFLAGS -L$with_ssl/lib"
+		AC_MSG_RESULT([Using SSL prefix... $with_ssl])
+	fi
+	AC_SUBST(openssl_h_present)
+	AC_SUBST(libssl_present)
+	AC_SUBST(libcrypto_present)
+	AC_CHECK_HEADER(openssl/ssl.h,[openssl_h_present=1])
+	AC_CHECK_LIB(crypto,ERR_load_BIO_strings,[libcrypto_present=1 && LIBS="-lcrypto $LIBS"])
+	AC_CHECK_LIB(ssl,SSL_CTX_new,[libssl_present=1 && LIBS="-lssl $LIBS"])
+	if test "x$openssl_h_present" = "x1" -a "x$libssl_present" = "x1" -a "x$libcrypto_present" = "x1"; then
+	       	AC_MSG_RESULT([OpenSSL library found, SSL support enabled])
+
+		# Check if SRTP should be compiled with OpenSSL
+		# support, to enable cryptos such as AES GCM.
+
+		# EVP_CIPHER_CTX is now opaque in OpenSSL 1.1.0, libsrtp 1.5.4 uses it as a transparent type.
+		# Update 2.7: our bundled libsrtp has been upgraded to 2.1.0,
+		# so we can omit EVP_CIPHER_CTX definition check now.
+		AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[#include <openssl/evp.h>]],
+						  [EVP_CIPHER_CTX *ctx;EVP_aes_128_gcm();])],
+				  [AC_CHECK_LIB(crypto,EVP_aes_128_gcm,[ac_ssl_has_aes_gcm=1])])
+		if test "x$ac_ssl_has_aes_gcm" = "x1"; then
+			AC_MSG_RESULT([OpenSSL has AES GCM support, SRTP will use OpenSSL])
+		else
+			AC_MSG_RESULT([OpenSSL AES GCM support not found, SRTP will only support AES CM cryptos])
 		fi
-		
-    		if test "x$ac_ssl_backend" = "x"; then
-
-		    if test "x$with_gnutls" != "xno" -a "x$with_gnutls" != "x"; then
-        	        CFLAGS="$CFLAGS -I$with_gnutls/include"
-        	        LDFLAGS="$LDFLAGS -L$with_gnutls/lib"
-        	        AC_MSG_RESULT([Using GnuTLS prefix... $with_gnutls])
-    		    fi
-
-        	    AC_CHECK_PROGS(PKG_CONFIG,
-                       $host-pkg-config pkg-config "python pkgconfig.py",
-                       none)
-        	    AC_MSG_RESULT([checking for GnuTLS installations..])
-        	    AC_SUBST(gnutls_h_present)
-        	    AC_SUBST(libgnutls_present)
-        	    AC_CHECK_HEADER(gnutls/gnutls.h, [gnutls_h_present=1])
-
-        	    if test "$PKG_CONFIG" != "none"; then
-            	    	if $PKG_CONFIG --exists gnutls; then
-                	    LIBS="$LIBS `$PKG_CONFIG --libs gnutls`"
-                	    libgnutls_present=1
-            		else
-                	    AC_CHECK_LIB(gnutls,
-                             gnutls_certificate_set_x509_system_trust,
-                             [libgnutls_present=1 &&
-                              LIBS="$LIBS -lgnutls"])
-            		fi
-        	    else
-            		AC_MSG_RESULT([*** Warning: neither pkg-config nor python is available, disabling gnutls. ***])
-        	    fi
-
-        	    if test "x$gnutls_h_present" = "x1" -a "x$libgnutls_present" = "x1"; then
-           		AC_MSG_RESULT([GnuTLS library found, SSL support enabled])
-			AC_DEFINE(PJ_HAS_SSL_SOCK, 1)
-			AC_DEFINE(PJ_SSL_SOCK_IMP, PJ_SSL_SOCK_IMP_GNUTLS)
-            		ac_ssl_backend="gnutls"
-        	    else
-            		AC_MSG_RESULT([** No GnuTLS libraries found, disabling SSL support **])
-        	    fi
-        	
-        	fi
-	      ])
+
+		# PJSIP_HAS_TLS_TRANSPORT setting follows PJ_HAS_SSL_SOCK
+		#AC_DEFINE(PJSIP_HAS_TLS_TRANSPORT, 1)
+		AC_DEFINE(PJ_HAS_SSL_SOCK, 1)
+	else
+		AC_MSG_RESULT([** OpenSSL libraries not found, disabling SSL support **])
+	fi
+fi
 
 dnl # Obsolete option --with-opencore-amrnb
 AC_ARG_WITH(opencore-amrnb,
-- 
2.20.1

